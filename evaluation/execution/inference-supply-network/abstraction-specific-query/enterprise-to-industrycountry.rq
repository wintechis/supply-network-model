PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX sn: <https://purl.org/sn/vocab#>
PREFIX esn: <https://example.org/esn/vocab#>
PREFIX csn: <https://example.org/csn/vocab#>
PREFIX isn: <https://example.org/isn/vocab#>
PREFIX osn: <https://example.org/osn/vocab#>

CONSTRUCT {
    ?BC1 a sn:MultidimensionalEntity ;
        sn:dimension ?B1 , ?C1 .
    ?B1 a csn:Country ;
        rdfs:label ?B1_label ;
        csn:inContinent ?D1 .
    ?C1 a isn:Industry ;
        rdfs:label ?C1_label .
    ?BC1 a sn:MultidimensionalEntity ;
        sn:dimension ?B1 , ?C1 .
    ?B2 a csn:Country ;
        rdfs:label ?B2_label ;
        csn:inContinent ?D2 .
    ?C2 a isn:Industry ;
        rdfs:label ?C2_label .
    ?relationBC a sn:Relation ;
        sn:from ?BC1 ; sn:into ?BC2 .
    _:BTV a sn:Volume ;
        sn:relation ?relationBC ;
        sn:time ?time ;
        sn:unit ?unit ;
        sn:quantity ?aggregatedQuantity .
} WHERE {
    { SELECT ?D1 ?D1_label ?D2 ?D2_label ?C1 ?C1_label ?C2 ?C2_label ?B1 ?B1_label ?B2 ?B2_label ?BC2 ?BC1 ?relationBC ?time ?unit (SUM(?quantity) AS ?aggregatedQuantity)
        WHERE {
            # infer network
            ?A1 a esn:Enterprise ;
                esn:registeredIn ?B1 ;
                esn:industry ?C1 .
            ?A2 a esn:Enterprise ;
                esn:registeredIn ?B2 ;
                esn:industry ?C2 .
            ?AR a esn:Trade ;
                sn:from ?A1 ; sn:into ?A2 .
            ?ARV a sn:Volume ;
                sn:relation ?AR ;
                sn:time ?time ;
                sn:unit ?unit ;
                sn:quantity ?quantity .
            ?B1 rdfs:label ?B1_label .
            ?B2 rdfs:label ?B2_label .
            ?C1 rdfs:label ?C1_label .
            ?C2 rdfs:label ?C2_label .
	        BIND ( IRI(CONCAT(STR(?B1),ENCODE_FOR_URI(?C2_label))) AS ?relationBC ) .
	        BIND ( IRI(CONCAT(STR(?B1),ENCODE_FOR_URI(?C1_label))) AS ?BC1 ) .
	        BIND ( IRI(CONCAT(STR(?B2),ENCODE_FOR_URI(?C2_label))) AS ?BC1 ) .

            # pass on associated entities
            OPTIONAL {
                ?A1 esn:continent ?D1 .
                ?D1 rdfs:label ?C1_label .
                ?A2 esn:continent ?D2 .
                ?D2 rdfs:label ?CD_label .
            }
        } GROUP BY ?D1 ?D1_label ?D2 ?D2_label ?C1 ?C1_label ?C2 ?C2_label ?B1 ?B1_label ?B2 ?B2_label ?relationB ?time ?unit } }
